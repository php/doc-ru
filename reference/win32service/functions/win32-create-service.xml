<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision: $ -->
<!-- EN-Revision: 0d5b0198bfeee039849d521866503120351476d3 Maintainer: sergey Status: ready -->
<!-- Reviewed: no -->

<!-- Generated by xml_proto.php v2.3. Found in /scripts directory of phpdoc. -->
<refentry xml:id="function.win32-create-service" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">
 <refnamediv>
  <refname>win32_create_service</refname>
  <refpurpose>Создаёт новую запись службы в базе данных SCM</refpurpose>
 </refnamediv>

 <refsect1 role="description">
  &reftitle.description;
  <methodsynopsis>
   <type>void</type><methodname>win32_create_service</methodname>
   <methodparam><type>array</type><parameter>details</parameter></methodparam>
   <methodparam choice="opt"><type>string</type><parameter>machine</parameter></methodparam>
  </methodsynopsis>
  <para>
   Пробует добавить службу в базу данных SCM. Для этого требуются права администратора.
  </para>
 </refsect1>

 <refsect1 role="parameters">
  &reftitle.parameters;
  <para>
   <variablelist>
    <varlistentry>
     <term><parameter>details</parameter></term>
     <listitem>
      <para>
       Массив деталей службы:
       <variablelist>
        <varlistentry>
         <term><parameter>service</parameter></term>
         <listitem>
          <para>
           Краткое название службы. Это имя, которое вы будете использовать
           для управления службой с помощью команды <literal>net</literal>.
           Служба должна быть уникальной (никакие две службы не могут иметь одно и то же название)
           и, в идеале, не должна содержать пробелов в названии.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>display</parameter></term>
         <listitem>
          <para>
           Отображаемое имя службы. Это имя, которое вы увидите в апплете служб.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>description</parameter></term>
         <listitem>
          <para>
           Подробное описание услуги. Это описание, которое вы увидите в апплете служб.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>user</parameter></term>
         <listitem>
          <para>
           Имя учётной записи пользователя, под которой вы хотите
           запускать службу. Если этот параметр не указан, служба будет работать
           под учётной записью LocalSystem.
           Если имя пользователя указано, вы также должны указать пароль.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>password</parameter></term>
         <listitem>
          <para>
           Пароль, соответствующий <parameter>user</parameter>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>path</parameter></term>
         <listitem>
          <para>
           Полный путь к исполняемому модулю, который будет запущен при запуске службы.
           Если не указано, будет использоваться путь к текущему процессу PHP.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>params</parameter></term>
         <listitem>
          <para>
           Параметры командной строки для передачи службе при её запуске.
           Если вы хотите запустить скрипт PHP как службу, то первым
           параметром должен быть полный путь к скрипту PHP, который вы собираетесь
           запустить. Если имя скрипта или путь содержат пробелы, заключите полный
           путь к скрипту в кавычки <literal>"</literal>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>load_order</parameter></term>
         <listitem>
          <para>
           Управляет load_order. Ещё не полностью поддерживается.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>svc_type</parameter></term>
         <listitem>
          <para>
           Устанавливает тип службы. Если опущено, будет использовано значение по умолчанию
           <constant>WIN32_SERVICE_WIN32_OWN_PROCESS</constant>.
           Не меняйте это, если вы не знаете, что делаете.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>start_type</parameter></term>
         <listitem>
          <para>
           Устанавливает способ запуска службы. По умолчанию используется
           <constant>WIN32_SERVICE_AUTO_START</constant>, что означает,
           что служба будет запущена при запуске машины.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>error_control</parameter></term>
         <listitem>
          <para>
           Сообщает SCM, что он должен делать при обнаружении проблемы со службой.
           По умолчанию это <constant>WIN32_SERVER_ERROR_IGNORE</constant>.
           Изменение этого значения пока поддерживается не полностью.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>delayed_start</parameter></term>
         <listitem>
          <para>
           Если для <parameter>delayed_start</parameter> установлено значение &true;,
           то это проинформирует SCM о том, что служба должна быть запущена после того,
           как будут запущены другие службы автозапуска, плюс небольшая задержка.
          </para>
          <para>
           Любую службу можно пометить как службу с отложенным автозапуском; однако
           этот параметр не действует, если <parameter>start_type</parameter> службы
           не равен <constant>WIN32_SERVICE_AUTO_START</constant>.
          </para>
          <para>
           Параметр применим только в Windows Vista и Windows Server 2008
           или более поздних версиях.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>base_priority</parameter></term>
         <listitem>
          <para>
           Чтобы уменьшить влияние на использование процессора, может потребоваться
           установить базовый приоритет ниже обычного.
          </para>
          <para>
           <parameter>base_priority</parameter> может быть одной из констант
           определённых в <link linkend="win32service.constants.basepriorities">базовых классах приоритета Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>dependencies</parameter></term>
         <listitem>
          <para>
           Чтобы определить зависимости для вашей службы, может потребоваться установить
           этот параметр для списка имён служб в массиве.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_delay</parameter></term>
         <listitem>
          <para>
           Этот параметр определяет задержку между ошибкой и выполнением действия восстановления.
           Значение в миллисекундах.
          </para>
          <para>
           Значение по умолчанию - 60000.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_action_1</parameter></term>
         <listitem>
          <para>
           Действие будет выполнено при первой ошибке. Значение по умолчанию -
           <constant>WIN32_SC_ACTION_NONE</constant>.
          </para>
          <para>
           Для <parameter>recovery_action_1</parameter> можно задать одну из констант
           <link linkend="win32service.constants.recovery-action">действий восстановления Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_action_2</parameter></term>
         <listitem>
          <para>
           Действие будет выполнено при второй ошибке. Значение по умолчанию -
           <constant>WIN32_SC_ACTION_NONE</constant>.
          </para>
          <para>
           Для <parameter>recovery_action_2</parameter> можно задать одну из констант
           <link linkend="win32service.constants.recovery-action">действий восстановления Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_action_3</parameter></term>
         <listitem>
          <para>
           Действие будет выполнено при последующих ошибках. Значение по умолчанию -
           <constant>WIN32_SC_ACTION_NONE</constant>.
          </para>
          <para>
           Для <parameter>recovery_action_3</parameter> можно задать одну из констант
           <link linkend="win32service.constants.recovery-action">действий восстановления Win32</link>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_reset_period</parameter></term>
         <listitem>
          <para>
           Счётчик отказов будет сброшен после задержки, определённой в параметре.
           Задержка указывается в секундах.
          </para>
          <para>
           Значение по умолчанию <literal>86400</literal>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_enabled</parameter></term>
         <listitem>
          <para>
           Установите для этого параметра значение &true; для включения настроек восстановления,
           &false; для отключения.
          </para>
          <para>
           Значение по умолчанию &false;
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_reboot_msg</parameter></term>
         <listitem>
          <para>
           Установите этот параметр, чтобы определить сообщение, сохраняемое в журнале событий Windows
           перед перезагрузкой. Используется, только если для одного из действий установлено значение
           <constant>WIN32_SC_ACTION_REBOOT</constant>.
          </para>
         </listitem>
        </varlistentry>
        <varlistentry>
         <term><parameter>recovery_command</parameter></term>
         <listitem>
          <para>
           Установите этот параметр, чтобы определить команду, выполняемую, если одно из действий определено, как
           <constant>WIN32_SC_ACTION_RUN_COMMAND</constant>.
          </para>
         </listitem>
        </varlistentry>
       </variablelist>
      </para>
     </listitem>
    </varlistentry>
    <varlistentry>
     <term><parameter>machine</parameter></term>
     <listitem>
      <para>
       Необязательное имя машины, на которой вы хотите создать службу.
       Если не указано, будет использоваться локальный компьютер.
      </para>
     </listitem>
    </varlistentry>
   </variablelist>
  </para>
 </refsect1>

 <refsect1 role="returnvalues">
  &reftitle.returnvalues;
  <para>
   &return.void;
  </para>
  <para>
   До версии 1.0.0, &win32service.noerror.false.error;
  </para>
 </refsect1>

 <refsect1 role="errors">
  &reftitle.errors;
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>service</parameter> не задано.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>path</parameter> не задано.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>svc_type</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>start_type</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>error_control</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>base_priority</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>recovery_delay</parameter> не в промежутке между
   0 и PHP_INT_MAX.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>recovery_action_1</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>recovery_action_2</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>recovery_action_3</parameter> указано неверно.
  </para>
  <para>
   Выбрасывается <classname>ValueError</classname>, если
   значение параметра <parameter>recovery_reset_period</parameter> не в промежутке между
   0 и PHP_INT_MAX.
  </para>
  <para>
   В случае возникновения ошибки выбрасывается <classname>Win32ServiceException</classname>.
  </para>
 </refsect1>

 <refsect1 role="changelog">
  &reftitle.changelog;
  <para>
   <informaltable>
    <tgroup cols="2">
     <thead>
      <row>
       <entry>&Version;</entry>
       <entry>&Description;</entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>PECL win32service 1.0.0</entry>
       <entry>
        Выбрасывает <classname>ValueError</classname> в случае неверных данных в параметрах,
        ранее возвращалось &false;.
       </entry>
      </row>
      <row>
       <entry>PECL win32service 1.0.0</entry>
       <entry>
        Выбрасывает <classname>Win32ServiceException</classname> в случае возникновения ошибки,
        ранее возвращался
        <link xmlns="http://docbook.org/ns/docbook" linkend="win32service.constants.errors">Код ошибки Win32</link>.
       </entry>
      </row>
      <row>
       <entry>PECL win32service 1.0.0</entry>
       <entry>
        Тип возврата теперь <type>void</type>, ранее был <type>mixed</type>.
       </entry>
      </row>
      <row>
       <entry>PECL win32service 0.4.0</entry>
       <entry>
        Добавлены параметры <parameter>dependencies</parameter>, <parameter>recovery_delay</parameter>,
        <parameter>recovery_action_1</parameter>, <parameter>recovery_action_2</parameter>,
        <parameter>recovery_action_3</parameter>, <parameter>recovery_reset_period</parameter>,
        <parameter>recovery_enabled</parameter>, <parameter>recovery_reboot_msg</parameter>
        и <parameter>recovery_command</parameter>.
       </entry>
      </row>
     </tbody>
    </tgroup>
   </informaltable>
  </para>
 </refsect1>

 <refsect1 role="examples">
  &reftitle.examples;
  <para>
   <example>
    <title>Пример использования <function>win32_create_service</function></title>
    <para>
     Создание сервиса с кратким названием 'dummyphp'.
    </para>
    <programlisting role="php">
<![CDATA[
<?php
$x = win32_create_service(array(
    'service'     => 'dummyphp',                                           // название сервиса
    'display'     => 'sample dummy PHP service',                           // краткое описание
    'description' => 'This is a dummy Windows service created using PHP.', // полное описание
    'params'      => '"' . __FILE__ . '"  run',                            // путь до скрипта и параметров
));
debug_zval_dump($x);
?>
]]>
     </programlisting>
   </example>
  </para>
  <para>
   <example>
    <title>Пример использования <function>win32_create_service</function> с зависимостями</title>
    <para>
     Создание сервиса с кратким названием 'dummyphp' и зависимостями.
    </para>
    <programlisting role="php">
<![CDATA[
<?php
$x = win32_create_service(array(
    'service'      => 'dummyphp',                                           // название сервиса
    'display'      => 'sample dummy PHP service',                           // краткое описание
    'description'  => 'This is a dummy Windows service created using PHP.', // полное описание
    'params'       => '"' . __FILE__ . '"  run',                            // путь до скрипта и параметров
    'dependencies' => array("Netman"),                                      // список зависимостей
));
debug_zval_dump($x);
?>
]]>
     </programlisting>
   </example>
  </para>
  <para>
   <example>
    <title>Пример использования <function>win32_create_service</function> с восстановлением</title>
    <para>
     Создание сервиса с кратким названием 'dummyphp' и настройками восстановления.
    </para>
    <programlisting role="php">
<![CDATA[
<?php
$x = win32_create_service(array(
    'service'               => 'dummyphp',                                           // название сервиса
    'display'               => 'sample dummy PHP service',                           // краткое описание
    'description'           => 'This is a dummy Windows service created using PHP.', // полное описание
    'params'                => '"' . __FILE__ . '"  run',                            // путь до скрипта и параметров
    'recovery_delay'        => 120000,                                               // Действие восстановления выполняется через 2 минуты.
    'recovery_action_1'     => WIN32_SC_ACTION_RESTART,                              // При первом сбое перезапускается служба.
    'recovery_action_2'     => WIN32_SC_ACTION_RUN_COMMAND,                          // При втором сбое выполняется команда
    'recovery_action_3'     => WIN32_SC_ACTION_NONE,                                 // При последующих сбоях ничего не делать
    'recovery_reset_period' => 86400,                                                // Сбросить счётчик ошибок через 1 день
    'recovery_enabled'      => true,                                                 // Включить параметр восстановления
    'recovery_reboot_msg'   => null,                                                 // Не определяйте сообщение о перезагрузке, здесь оно не нужно
    'recovery_command'      => "c:\clean-service.bat",                               // Когда действие - WIN32_SC_ACTION_RUN_COMMAND, выполняется эта команда
));
debug_zval_dump($x);
?>
]]>
     </programlisting>
   </example>
  </para>
 </refsect1>

 <refsect1 role="seealso">
  &reftitle.seealso;
  <para>
   <simplelist>
    <member><function>win32_delete_service</function></member>
    <member><link linkend="win32service.constants.basepriorities">Базовые классы приоритета Win32</link></member>
    <member><link linkend="win32service.constants.recovery-action">Действия восстановления Win32</link></member>
    <member><link linkend="win32service.constants.errors">Коды ошибок Win32</link></member>
   </simplelist>
  </para>
 </refsect1>

</refentry>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"~/.phpdoc/manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
